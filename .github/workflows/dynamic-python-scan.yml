
name: Dynamic Python Code Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit pylint
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
      
    - name: Run Python code scans
      run: |
        echo "Starting Python code scans..."
        echo 'Running Pylint Code Quality...'
        pylint **/*.py --output-format=json > $REPORT_DIR/pylint.json || true
        echo 'Running Bandit Security Scanner...'
        bandit -r . -f json -o $REPORT_DIR/bandit.json || true
        echo "All scans completed. Reports saved to $REPORT_DIR"
        
    - name: Generate severity summary
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        severity_summary = {
            'critical': [],
            'high': [],
            'medium': [],
            'low': [],
            'info': []
        }
        
        # Process Bandit results
        if (report_dir / 'bandit.json').exists():
            try:
                with open(report_dir / 'bandit.json') as f:
                    bandit_data = json.load(f)
                    for result in bandit_data.get('results', []):
                        severity = result.get('issue_severity', 'unknown').lower()
                        if severity in severity_summary:
                            severity_summary[severity].append({
                                'tool': 'bandit',
                                'file': result.get('filename'),
                                'line': result.get('line_number'),
                                'issue': result.get('test_name'),
                                'message': result.get('issue_text')
                            })
            except Exception as e:
                print(f"Error processing bandit.json: {e}")
        
        # Process Pylint results
        if (report_dir / 'pylint.json').exists():
            try:
                with open(report_dir / 'pylint.json') as f:
                    pylint_data = json.load(f)
                    for msg in pylint_data:
                        if msg.get('type') == 'error':
                            severity_summary['high'].append({
                                'tool': 'pylint',
                                'file': msg.get('path'),
                                'line': msg.get('line'),
                                'issue': msg.get('message-id'),
                                'message': msg.get('message')
                            })
                        elif msg.get('type') == 'warning':
                            severity_summary['medium'].append({
                                'tool': 'pylint',
                                'file': msg.get('path'),
                                'line': msg.get('line'),
                                'issue': msg.get('message-id'),
                                'message': msg.get('message')
                            })
            except Exception as e:
                print(f"Error processing pylint.json: {e}")
        
        # Process pip-audit results
        if (report_dir / 'pip_audit.json').exists():
            try:
                with open(report_dir / 'pip_audit.json') as f:
                    pip_audit_data = json.load(f)
                    for vuln in pip_audit_data.get('vulnerabilities', []):
                        severity = vuln.get('severity', 'unknown').lower()
                        if severity in severity_summary:
                            severity_summary[severity].append({
                                'tool': 'pip-audit',
                                'package': vuln.get('name'),
                                'version': vuln.get('installed_version'),
                                'issue': vuln.get('id'),
                                'message': vuln.get('description', 'Vulnerability found')
                            })
            except Exception as e:
                print(f"Error processing pip_audit.json: {e}")
        
        # Process Flake8 results
        if (report_dir / 'flake8.json').exists():
            try:
                with open(report_dir / 'flake8.json') as f:
                    flake8_data = json.load(f)
                    for result in flake8_data:
                        # Flake8 doesn't have severity, categorize by error code
                        code = result.get('code', '').startswith('E')
                        if code:
                            severity_summary['medium'].append({
                                'tool': 'flake8',
                                'file': result.get('filename'),
                                'line': result.get('line_number'),
                                'issue': result.get('code'),
                                'message': result.get('message', 'Style error')
                            })
                        else:
                            severity_summary['low'].append({
                                'tool': 'flake8',
                                'file': result.get('filename'),
                                'line': result.get('line_number'),
                                'issue': result.get('code'),
                                'message': result.get('message', 'Style warning')
                            })
            except Exception as e:
                print(f"Error processing flake8.json: {e}")
        
        # Process Radon Cyclomatic Complexity results
        if (report_dir / 'radon_cc.json').exists():
            try:
                with open(report_dir / 'radon_cc.json') as f:
                    radon_data = json.load(f)
                    for file_path, metrics in radon_data.items():
                        complexity = metrics.get('total_complexity', 0)
                        if complexity > 10:
                            severity_summary['high'].append({
                                'tool': 'radon_cc',
                                'file': file_path,
                                'line': 'N/A',
                                'issue': 'High complexity',
                                'message': 'Cyclomatic complexity: ' + str(complexity)
                            })
                        elif complexity > 5:
                            severity_summary['medium'].append({
                                'tool': 'radon_cc',
                                'file': file_path,
                                'line': 'N/A',
                                'issue': 'Medium complexity',
                                'message': 'Cyclomatic complexity: ' + str(complexity)
                            })
            except Exception as e:
                print(f"Error processing radon_cc.json: {e}")
        
        # Process Radon Maintainability Index results
        if (report_dir / 'radon_mi.json').exists():
            try:
                with open(report_dir / 'radon_mi.json') as f:
                    radon_data = json.load(f)
                    for file_path, metrics in radon_data.items():
                        mi_score = metrics.get('mi', 0)
                        if mi_score < 20:
                            severity_summary['high'].append({
                                'tool': 'radon_mi',
                                'file': file_path,
                                'line': 'N/A',
                                'issue': 'Low maintainability',
                                'message': 'Maintainability Index: ' + str(mi_score)
                            })
                        elif mi_score < 50:
                            severity_summary['medium'].append({
                                'tool': 'radon_mi',
                                'file': file_path,
                                'line': 'N/A',
                                'issue': 'Moderate maintainability',
                                'message': 'Maintainability Index: ' + str(mi_score)
                            })
            except Exception as e:
                print(f"Error processing radon_mi.json: {e}")
        
        # Process Pydocstyle results
        if (report_dir / 'pydocstyle.json').exists():
            try:
                with open(report_dir / 'pydocstyle.json') as f:
                    pydocstyle_data = json.load(f)
                    for result in pydocstyle_data:
                        code = result.get('code', '')
                        # Categorize by docstyle error codes
                        if code.startswith('D1') or code.startswith('D2'):
                            severity_summary['low'].append({
                                'tool': 'pydocstyle',
                                'file': result.get('filename'),
                                'line': result.get('line'),
                                'issue': code,
                                'message': result.get('message', 'Documentation issue')
                            })
                        else:
                            severity_summary['info'].append({
                                'tool': 'pydocstyle',
                                'file': result.get('filename'),
                                'line': result.get('line'),
                                'issue': code,
                                'message': result.get('message', 'Documentation style')
                            })
            except Exception as e:
                print(f"Error processing pydocstyle.json: {e}")
        
        # Save severity summary
        with open(report_dir / 'severity_summary.json', 'w') as f:
            json.dump(severity_summary, f, indent=2)
            
        print("Severity summary generated successfully")
        EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
        
    - name: Send results to API
      if: always()
      run: |
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @- \
            "https://eop7f15rcm9dnz.m.pipedream.net" << EOF
        {
          "repository": "${{ github.repository }}",
          "branch": "${{ github.ref_name }}",
          "run_id": "${{ github.run_id }}",
          "severity_results": $(cat $REPORT_DIR/severity_summary.json),
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        fi

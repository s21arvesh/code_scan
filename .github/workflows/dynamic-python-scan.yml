name: Dynamic Python Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing Python packages..."
        pip install bandit pydocstyle pylint flake8==6.1.0 flake8-json==24.4.0 pip-audit radon
        
    - name: Install additional scan tools
      run: |
        echo "Installing Go for dependency scanning tools..."
        if command -v go >/dev/null 2>&1; then
          echo "Go is already installed"
        else
          echo "Installing Go..."
          wget -q https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
        fi
        export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
        echo "Installing dependency scanning tools..."
        # Install OSV Scanner (try pip first, fallback to Go)
        pip install osv-scanner || (go install github.com/google/osv-scanner/cmd/osv-scanner@latest) || echo "OSV Scanner installation failed"
        
        # Install Syft
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin || echo "Syft installation failed"
        
        # Install Grype  
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || echo "Grype installation failed"
        
        # Install Trivy
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || echo "Trivy installation failed"
        
        # Install ScanCode Toolkit
        pip install scancode-toolkit || echo "ScanCode installation failed"
        
        # Install TruffleHog
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sudo sh -s -- -b /usr/local/bin || echo "TruffleHog installation failed"
        
        # Install Gitleaks
        GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz && sudo tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks && sudo chmod +x /usr/local/bin/gitleaks || echo "Gitleaks installation failed"
        
        # Install Modelscan
        pip install modelscan || echo "Modelscan installation failed"
        
        # Install Yara Rules Scanner
        sudo apt-get update && sudo apt-get install -y yara || pip install yara-python || echo "Yara installation failed"
        
        # Install ClamAV Antivirus Scanner
        sudo apt-get update && sudo apt-get install -y clamav clamav-freshclam || echo "ClamAV installation failed"
        
        export PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
        echo "Verifying installations:"
        which bandit || echo "bandit not found in PATH"
        which pylint || echo "pylint not found in PATH"
        which flake8 || echo "flake8 not found in PATH"
        which osv-scanner || echo "osv-scanner not found in PATH"
        which syft || echo "syft not found in PATH"
        which grype || echo "grype not found in PATH"
        which trivy || echo "trivy not found in PATH"
        which scancode || echo "scancode not found in PATH"
        which trufflehog || echo "trufflehog not found in PATH"
        which gitleaks || echo "gitleaks not found in PATH"
        which modelscan || echo "modelscan not found in PATH"
        which yara || echo "yara not found in PATH"
        which clamscan || echo "clamscan not found in PATH"
        echo ""
        echo "Version checks:"
        bandit --version || echo "bandit version failed"
        pylint --version || echo "pylint version failed"
        flake8 --version || echo "flake8 version failed"
        osv-scanner --version || echo "OSV Scanner version failed"
        syft --version || echo "Syft version failed"
        grype --version || echo "Grype version failed"
        trivy --version || echo "Trivy version failed"
        scancode --version || echo "ScanCode version failed"
        trufflehog --version || echo "TruffleHog version failed"
        gitleaks --version || echo "Gitleaks version failed"
        modelscan --version || echo "Modelscan version failed"
        yara --version || echo "Yara version failed"
        clamscan --version || echo "ClamAV version failed"
        export PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
        # Install any additional complex tools dynamically
        
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Run scans
      run: |
        set +e
        echo 'Running Bandit Security Scanner...'
        bandit -r . -f json -o $REPORT_DIR/bandit.json || true
        echo 'Running Pylint Code Quality...'
        pylint . --output-format=json > $REPORT_DIR/pylint.json 2>/dev/null || true
        echo 'Running Flake8 Style Checker...'
        echo 'Running flake8...'; echo 'import os,sys' > force_flake8.py; flake8 force_flake8.py --format=json --output-file=$REPORT_DIR/flake8.json --exit-zero || true; flake8 . --format=json --output-file=$REPORT_DIR/flake8.json --exit-zero || true
        echo 'Running Radon Cyclomatic Complexity...'
        radon cc . -a -j > $REPORT_DIR/radon_cc.json || true
        echo 'Running Radon Maintainability Index...'
        radon mi . -j > $REPORT_DIR/radon_mi.json || true
        echo 'Running pip-audit Vulnerability Scanner...'
        pip-audit -f json -o $REPORT_DIR/pip_audit.json || true
        echo 'Running Pydocstyle Documentation Checker...'
        pydocstyle . --format=json > $REPORT_DIR/pydocstyle.json || true
        echo 'Running OSV Scanner...'
        osv-scanner scan . --format json --output $REPORT_DIR/osv_scanner.json || echo '{"results": []}' > $REPORT_DIR/osv_scanner.json
        echo 'Running Syft SBOM Generator...'
        syft . -o json > $REPORT_DIR/syft.json || echo '{"artifacts": []}' > $REPORT_DIR/syft.json
        echo 'Running Trivy Vulnerability Scanner...'
        trivy fs --format json --output $REPORT_DIR/trivy.json . || echo '{"Results": []}' > $REPORT_DIR/trivy.json
        echo 'Running Grype Vulnerability Scanner...'
        grype dir:. -o json > $REPORT_DIR/grype.json || echo '{"matches": []}' > $REPORT_DIR/grype.json
        echo 'Running ScanCode Toolkit...'
        scancode -n 2 --timeout 120 --license --package --info --json $REPORT_DIR/scancode.json --include "*.py" --include "*.txt" --include "*.md" --include "LICENSE" . || echo '{"headers":[],"files":[]}' > $REPORT_DIR/scancode.json
        echo 'Running TruffleHog...'
        trufflehog filesystem --directory . --json > $REPORT_DIR/trufflehog.json || echo '[]' > $REPORT_DIR/trufflehog.json
        echo 'Running Gitleaks...'
        gitleaks detect --source . --report-format json --report-path $REPORT_DIR/gitleaks.json --verbose --no-git || echo '[]' > $REPORT_DIR/gitleaks.json
        echo 'Running Modelscan...'
        modelscan scan -p . 2>&1 | tee $REPORT_DIR/modelscan.txt || true; echo '{"vulnerabilities": []}' > $REPORT_DIR/modelscan.json
        echo 'Running Yara Rules Scanner...'
        mkdir -p yara_rules && echo "rule Hardcoded_AWS_Key { strings: \$a = /AKIA[0-9A-Z]{16}/ condition: \$a }" > yara_rules/suspicious_strings.yar && yara -r yara_rules/suspicious_strings.yar . > $REPORT_DIR/yara.txt 2>/dev/null || echo 'No matches found' > $REPORT_DIR/yara.txt
        echo 'Running ClamAV Antivirus Scanner...'
        clamscan -r . > $REPORT_DIR/clamav.txt 2>/dev/null || true; echo '{"infected_files": []}' > $REPORT_DIR/clamav.json
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30

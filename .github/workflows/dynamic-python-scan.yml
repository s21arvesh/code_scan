name: Dynamic Python Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing Python packages..."
        pip install pylint bandit flake8==6.1.0 flake8-json==24.4.0 modelscan pydocstyle radon pip-audit
        
    - name: Install additional scan tools
      run: |
        echo "Installing Go for dependency scanning tools..."
        if command -v go >/dev/null 2>&1; then
          echo "Go is already installed"
        else
          echo "Installing Go..."
          wget -q https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
        fi
        export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
        echo "Installing dependency scanning tools..."
        # Install OSV Scanner (try pip first, fallback to Go)
        pip install osv-scanner || (go install github.com/google/osv-scanner/cmd/osv-scanner@latest) || echo "OSV Scanner installation failed"
        
        # Install Syft
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin || echo "Syft installation failed"
        
        # Install Grype  
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || echo "Grype installation failed"
        
        # Install Trivy
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || echo "Trivy installation failed"
        
        # Install ScanCode Toolkit
        pip install scancode-toolkit || echo "ScanCode installation failed"
        
        # Install TruffleHog
        pip install trufflehog3 || echo "TruffleHog installation failed"
        
        # Install Gitleaks
        GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz && sudo tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks && sudo chmod +x /usr/local/bin/gitleaks || echo "Gitleaks installation failed"
        
        export PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
        # Install any additional complex tools dynamically
        sudo apt-get update && sudo apt-get install -y yara || pip install yara-python
        sudo apt-get update && sudo apt-get install -y clamav clamav-freshclam || echo 'ClamAV installation failed, using fallback'
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Run scans
      run: |
        echo 'Running Bandit Security Scanner...'
        bandit -r . -f json -o $REPORT_DIR/bandit.json || true
        echo 'Running Pylint Code Quality...'
        pylint . --output-format=json > $REPORT_DIR/pylint.json 2>/dev/null || true
        echo 'Running Flake8 Style Checker...'
        echo 'Running flake8...'; echo 'import os,sys' > force_flake8.py; flake8 force_flake8.py --format=json --output-file=$REPORT_DIR/flake8.json --exit-zero || true; flake8 . --format=json --output-file=$REPORT_DIR/flake8.json --exit-zero || true
        echo 'Running Radon Cyclomatic Complexity...'
        radon cc . -a -j > $REPORT_DIR/radon_cc.json || true
        echo 'Running Radon Maintainability Index...'
        radon mi . -j > $REPORT_DIR/radon_mi.json || true
        echo 'Running pip-audit Vulnerability Scanner...'
        pip-audit -f json -o $REPORT_DIR/pip_audit.json || true
        echo 'Running Pydocstyle Documentation Checker...'
        pydocstyle . --format=json > $REPORT_DIR/pydocstyle.json || true
        echo 'Running OSV Scanner...'
        osv-scanner scan . --format json --output $REPORT_DIR/osv_scanner.json || echo '{"results": []}' > $REPORT_DIR/osv_scanner.json
        echo 'Running Syft SBOM Generator...'
        syft . -o json > $REPORT_DIR/syft.json || echo '{"artifacts": []}' > $REPORT_DIR/syft.json
        echo 'Running Trivy Vulnerability Scanner...'
        trivy fs --format json --output $REPORT_DIR/trivy.json . || echo '{"Results": []}' > $REPORT_DIR/trivy.json
        echo 'Running Grype Vulnerability Scanner...'
        grype dir:. -o json > $REPORT_DIR/grype.json || echo '{"matches": []}' > $REPORT_DIR/grype.json
        echo 'Running ScanCode Toolkit...'
        scancode . --json $REPORT_DIR/scancode.json --copyright --license --package --info || echo '{"files": []}' > $REPORT_DIR/scancode.json
        echo 'Running TruffleHog...'
        trufflehog filesystem --directory . --json --output $REPORT_DIR/trufflehog.json 2>/dev/null || echo '{"FoundIssues": []}' > $REPORT_DIR/trufflehog.json
        echo 'Running Gitleaks...'
        gitleaks detect --source . --report-format json --report-path $REPORT_DIR/gitleaks.json --verbose || echo '{"Findings": []}' > $REPORT_DIR/gitleaks.json
        echo 'Running Modelscan...'
        modelscan . --json --output $REPORT_DIR/modelscan.json 2>/dev/null || echo '{"vulnerabilities": []}' > $REPORT_DIR/modelscan.json
        echo 'Running Yara Rules Scanner...'
        yara --recursive . /usr/share/yara/rules/malware.yar --json > $REPORT_DIR/yara.json 2>/dev/null || yara --recursive . /usr/share/yara/rules/* --json > $REPORT_DIR/yara.json 2>/dev/null || echo '{"matches": []}' > $REPORT_DIR/yara.json
        echo 'Running ClamAV Antivirus Scanner...'
        freshclam --quiet && clamscan --recursive=yes --detect-pua=yes --scan-archive=yes --json=yes . 2>$REPORT_DIR/clamav.log || echo '{"infected_files": []}' > $REPORT_DIR/clamav.json
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30

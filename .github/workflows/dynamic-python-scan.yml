
name: Dynamic Python Code Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit
        echo "Installing additional scan tools..."
        pip install bandit pylint flake8 radon pydocstyle pip-audit
        echo "Verifying installations:"
        bandit --version
        pylint --version
        flake8 --version
        radon --version
        pydocstyle --version
        pip-audit --version
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Run Python code scans
      run: |
        echo "Starting Python code scans..."
        echo "Current directory: $(pwd)"
        echo "Report directory: $REPORT_DIR"
        echo "Python files found:"
        find . -name "*.py" -type f | head -10
        echo "=== Running Scan Commands ==="
        echo "DEBUG: Current directory: $(pwd)"
        echo "DEBUG: Python files in current directory:"
        find . -name "*.py" -type f -exec echo "  - {}" \;
        echo "DEBUG: About to execute scan_commands..."
        echo 'Running Bandit Security Scanner...'
        bandit -r . -f json > $REPORT_DIR/bandit.json 2>/dev/null || echo '{}' > $REPORT_DIR/bandit.json
        echo "DEBUG: scan_commands completed"
        echo "=== Scan Commands Completed ==="
        echo "Report directory contents after scans:"
        ls -la $REPORT_DIR/
        echo "=== Checking each tool's report file ==="
        echo "Bandit report file:"
        if [ -f "$REPORT_DIR/bandit.json" ]; then
          echo "Bandit report exists"
          echo "Bandit report size: $(wc -c < $REPORT_DIR/bandit.json)"
          echo "Bandit report preview:"
          head -20 $REPORT_DIR/bandit.json
        else
          echo "Bandit report NOT found"
        fi
        echo "Pylint report file:"
        if [ -f "$REPORT_DIR/pylint.json" ]; then
          echo "Pylint report exists"
          echo "Pylint report size: $(wc -c < $REPORT_DIR/pylint.json)"
          echo "Pylint report preview:"
          head -20 $REPORT_DIR/pylint.json
        else
          echo "Pylint report NOT found"
        fi
        echo "Flake8 report file:"
        if [ -f "$REPORT_DIR/flake8.json" ]; then
          echo "Flake8 report exists"
          echo "Flake8 report size: $(wc -c < $REPORT_DIR/flake8.json)"
          echo "Flake8 report preview:"
          head -20 $REPORT_DIR/flake8.json
        else
          echo "Flake8 report NOT found"
        fi
        echo "Pip-audit report file:"
        if [ -f "$REPORT_DIR/pip_audit.json" ]; then
          echo "Pip-audit report exists"
          echo "Pip-audit report size: $(wc -c < $REPORT_DIR/pip_audit.json)"
          echo "Pip-audit report preview:"
          head -20 $REPORT_DIR/pip_audit.json
        else
          echo "Pip-audit report NOT found"
        fi
        echo "Radon CC report file:"
        if [ -f "$REPORT_DIR/radon_cc.json" ]; then
          echo "Radon CC report exists"
          echo "Radon CC report size: $(wc -c < $REPORT_DIR/radon_cc.json)"
          echo "Radon CC report preview:"
          head -20 $REPORT_DIR/radon_cc.json
        else
          echo "Radon CC report NOT found"
        fi
        echo "Radon MI report file:"
        if [ -f "$REPORT_DIR/radon_mi.json" ]; then
          echo "Radon MI report exists"
          echo "Radon MI report size: $(wc -c < $REPORT_DIR/radon_mi.json)"
          echo "Radon MI report preview:"
          head -20 $REPORT_DIR/radon_mi.json
        else
          echo "Radon MI report NOT found"
        fi
        echo "Pydocstyle report file:"
        if [ -f "$REPORT_DIR/pydocstyle.json" ]; then
          echo "Pydocstyle report exists"
          echo "Pydocstyle report size: $(wc -c < $REPORT_DIR/pydocstyle.json)"
          echo "Pydocstyle report preview:"
          head -20 $REPORT_DIR/pydocstyle.json
        else
          echo "Pydocstyle report NOT found"
        fi
        echo "=== Manual tool checks ==="
        echo "Running bandit manually to debug:"
        echo "Bandit version:"
        bandit --version
        echo "Manual bandit execution:"
        bandit -r . -f json || echo "Bandit failed"
        echo "Manual bandit to file:"
        bandit -r . -f json > $REPORT_DIR/manual_bandit.json 2>/dev/null || echo "Manual bandit to file failed"
        echo "Manual bandit file size: $(wc -c < $REPORT_DIR/manual_bandit.json 2>/dev/null || echo '0')"
        echo "Manual bandit file preview:"
        head -10 $REPORT_DIR/manual_bandit.json 2>/dev/null || echo "No manual bandit file"
        echo "Running flake8 manually to check:"
        flake8 . --version
        echo "Running flake8 on current directory:"
        flake8 . --format=json || echo "No flake8 issues found"
        
    - name: Generate severity summary
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        print("DEBUG: Report directory: " + str(report_dir))
        print("DEBUG: Report directory exists: " + str(report_dir.exists()))
        print("DEBUG: Report directory contents: " + str(list(report_dir.glob('*'))))
        
        # Check which report files exist
        report_files = ['bandit.json', 'pylint.json', 'flake8.json', 'pip_audit.json', 'radon_cc.json', 'radon_mi.json', 'pydocstyle.json']
        for file_name in report_files:
            file_path = report_dir / file_name
            if file_path.exists():
                print("DEBUG: " + file_name + " exists with size: " + str(file_path.stat().st_size))
            else:
                print("DEBUG: " + file_name + " does not exist")
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []
        
        # Process Bandit results
        if (report_dir / 'bandit.json').exists():
            try:
                with open(report_dir / 'bandit.json') as f:
                    bandit_data = json.load(f)
                    print("DEBUG: Bandit data loaded: " + str(len(bandit_data.get('results', []))) + " issues found")
                    
                    for result in bandit_data.get('results', []):
                        bandit_severity = result.get('issue_severity', 'unknown').upper()
                        
                        # Map bandit severity to our severity levels
                        if bandit_severity == 'HIGH':
                            severity_summary['high'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'MEDIUM':
                            severity_summary['medium'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'LOW':
                            severity_summary['low'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        else:
                            severity_summary['info'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                    
                    print("DEBUG: Bandit severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing bandit.json: " + str(e))
                print("DEBUG: Bandit file content preview:")
                try:
                    with open(report_dir / 'bandit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read bandit.json file")
        
        # Process Pylint results
        if (report_dir / 'pylint.json').exists():
            try:
                with open(report_dir / 'pylint.json') as f:
                    pylint_data = json.load(f)
                    for msg in pylint_data:
                        if msg.get('type') == 'error':
                            severity_summary['high'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
                        elif msg.get('type') == 'warning':
                            severity_summary['medium'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
            except Exception as e:
                print("Error processing pylint.json: " + str(e))
        
        # Process pip-audit results
        if (report_dir / 'pip_audit.json').exists():
            try:
                with open(report_dir / 'pip_audit.json') as f:
                    pip_audit_data = json.load(f)
                    print("DEBUG: Pip-audit data loaded: " + str(len(pip_audit_data.get('dependencies', []))) + " dependencies found")
                    print("DEBUG: Pip-audit raw data structure: " + str(list(pip_audit_data.keys()) if isinstance(pip_audit_data, dict) else type(pip_audit_data)))
                    for vuln in pip_audit_data.get('dependencies', []):
                        # Check if this dependency has vulnerabilities
                        if 'vulns' in vuln and vuln['vulns']:
                            severity = vuln.get('severity', 'unknown').lower()
                            if severity in severity_summary:
                                severity_summary[severity].append(dict(
                                    tool='pip-audit',
                                    file='requirements.txt',
                                    issue=vuln.get('name', 'vulnerability'),
                                    message=vuln.get('description', 'Security vulnerability')
                                ))
                    print("DEBUG: Pip-audit severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing pip_audit.json: " + str(e))
                print("DEBUG: Pip-audit file content preview:")
                try:
                    with open(report_dir / 'pip_audit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read pip_audit.json file")
        else:
            print("DEBUG: pip_audit.json file not found")
        
        # Process Flake8 results
        if (report_dir / 'flake8.json').exists():
            try:
                with open(report_dir / 'flake8.json') as f:
                    flake8_data = json.load(f)
                    print("DEBUG: Flake8 data loaded: " + str(len(flake8_data)) + " issues found")
                    for result in flake8_data:
                        # Flake8 doesn't have severity, categorize by error code
                        error_code = result.get('code', '')
                        if error_code.startswith('E'):
                            severity_summary['high'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 error')
                            ))
                        elif error_code.startswith('W'):
                            severity_summary['medium'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 warning')
                            ))
                        else:
                            severity_summary['low'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 info')
                            ))
            except Exception as e:
                print("Error processing flake8.json: " + str(e))
                print("DEBUG: Flake8 file content preview:")
                try:
                    with open(report_dir / 'flake8.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read flake8.json file")
        else:
            print("DEBUG: flake8.json file not found")
        
        # Process Radon Cyclomatic Complexity results
        if (report_dir / 'radon_cc.json').exists():
            try:
                with open(report_dir / 'radon_cc.json') as f:
                    radon_data = json.load(f)
                    print("DEBUG: Radon CC data loaded: " + str(len(radon_data)) + " files analyzed")
                    print("DEBUG: Radon CC raw data structure: " + str(list(radon_data.keys()) if isinstance(radon_data, dict) else type(radon_data)))
                    for file_path, metrics in radon_data.items():
                        complexity = metrics.get('total_complexity', 0)
                        if complexity > 10:
                            severity_summary['high'].append(dict(
                                tool='radon_cc',
                                file=file_path,
                                issue='high_complexity',
                                message='Cyclomatic complexity: ' + str(complexity)
                            ))
                        elif complexity > 5:
                            severity_summary['medium'].append(dict(
                                tool='radon_cc',
                                file=file_path,
                                issue='medium_complexity',
                                message='Cyclomatic complexity: ' + str(complexity)
                            ))
                    print("DEBUG: Radon CC severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing radon_cc.json: " + str(e))
                print("DEBUG: Radon CC file content preview:")
                try:
                    with open(report_dir / 'radon_cc.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read radon_cc.json file")
        else:
            print("DEBUG: radon_cc.json file not found")
        
        # Process Radon Maintainability Index results
        if (report_dir / 'radon_mi.json').exists():
            try:
                with open(report_dir / 'radon_mi.json') as f:
                    radon_data = json.load(f)
                    print("DEBUG: Radon MI data loaded: " + str(len(radon_data)) + " files analyzed")
                    print("DEBUG: Radon MI raw data structure: " + str(list(radon_data.keys()) if isinstance(radon_data, dict) else type(radon_data)))
                    for file_path, metrics in radon_data.items():
                        mi_score = metrics.get('mi', 0)
                        if mi_score < 20:
                            severity_summary['high'].append(dict(
                                tool='radon_mi',
                                file=file_path,
                                issue='low_maintainability',
                                message='Maintainability Index: ' + str(mi_score)
                            ))
                        elif mi_score < 50:
                            severity_summary['medium'].append(dict(
                                tool='radon_mi',
                                file=file_path,
                                issue='medium_maintainability',
                                message='Maintainability Index: ' + str(mi_score)
                            ))
                    print("DEBUG: Radon MI severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing radon_mi.json: " + str(e))
                print("DEBUG: Radon MI file content preview:")
                try:
                    with open(report_dir / 'radon_mi.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read radon_mi.json file")
        else:
            print("DEBUG: radon_mi.json file not found")
        
        # Process Pydocstyle results
        if (report_dir / 'pydocstyle.json').exists():
            try:
                with open(report_dir / 'pydocstyle.json') as f:
                    pydocstyle_data = json.load(f)
                    print("DEBUG: Pydocstyle data loaded: " + str(len(pydocstyle_data)) + " issues found")
                    print("DEBUG: Pydocstyle raw data structure: " + str(list(pydocstyle_data.keys()) if isinstance(pydocstyle_data, dict) else type(pydocstyle_data)))
                    for result in pydocstyle_data:
                        code = result.get('code', '')
                        if code.startswith('D'):
                            severity_summary['low'].append(dict(
                                tool='pydocstyle',
                                file=result.get('filename'),
                                line=result.get('line'),
                                issue=code,
                                message=result.get('message', 'Documentation style')
                            ))
                    print("DEBUG: Pydocstyle severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing pydocstyle.json: " + str(e))
                print("DEBUG: Pydocstyle file content preview:")
                try:
                    with open(report_dir / 'pydocstyle.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read pydocstyle.json file")
        else:
            print("DEBUG: pydocstyle.json file not found")
        
        # Save severity summary
        with open(report_dir / 'severity_summary.json', 'w') as f:
            json.dump(severity_summary, f, indent=2)
        
        # Check manual bandit results if automated failed
        if (report_dir / 'manual_bandit.json').exists():
            try:
                with open(report_dir / 'manual_bandit.json') as f:
                    manual_bandit_data = json.load(f)
                    print("DEBUG: Manual bandit results:")
                    print("Issues found: " + str(len(manual_bandit_data.get('results', []))))
                    for result in manual_bandit_data.get('results', [])[:5]:  # Show first 5
                        print("  - " + result.get('test_name', 'Unknown') + ": " + result.get('issue_text', 'No description'))
            except Exception as e:
                print("DEBUG: Error reading manual bandit: " + str(e))
        
        print("=== FINAL SEVERITY SUMMARY ===")
        for severity, issues in severity_summary.items():
            print(str(severity) + ": " + str(len(issues)) + " issues")
        print("Severity summary generated successfully")
        EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30

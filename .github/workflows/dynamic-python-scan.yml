
name: Dynamic Python Code Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pydocstyle flake8 radon bandit pip-audit
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
      
    - name: Run Python code scans
      run: |
        echo "Starting Python code scans..."
        echo "Current directory: $(pwd)"
        echo "Report directory: $REPORT_DIR"
        echo "Python files found:"
        find . -name "*.py" -type f | head -10
        echo "=== Running Scan Commands ==="
        echo 'Running Bandit Security Scanner...'
        bandit -r . -f json -o $REPORT_DIR/bandit.json 2>/dev/null || echo '{}' > $REPORT_DIR/bandit.json
        echo 'Running Pylint Code Quality...'
        pylint **/*.py --output-format=json > $REPORT_DIR/pylint.json || true
        echo 'Running Flake8 Style Checker...'
        flake8 . --format=json --output-file=$REPORT_DIR/flake8.json 2>/dev/null || echo '[]' > $REPORT_DIR/flake8.json
        echo 'Running pip-audit Vulnerability Scanner...'
        pip-audit --format=json --output=$REPORT_DIR/pip_audit.json || true
        echo 'Running Radon Cyclomatic Complexity...'
        radon cc --json . > $REPORT_DIR/radon_cc.json || true
        echo 'Running Radon Maintainability Index...'
        radon mi --json . > $REPORT_DIR/radon_mi.json || true
        echo 'Running Pydocstyle Documentation Checker...'
        pydocstyle **/*.py --json > $REPORT_DIR/pydocstyle.json || true
        echo "=== Scan Commands Completed ==="
        echo "Report directory contents after scans:"
        ls -la $REPORT_DIR/
        echo "Bandit report file:"
        if [ -f "$REPORT_DIR/bandit.json" ]; then
          echo "Bandit report exists"
          echo "Bandit report size: $(wc -c < $REPORT_DIR/bandit.json)"
          echo "Bandit report preview:"
          head -20 $REPORT_DIR/bandit.json
        else
          echo "Bandit report NOT found"
        fi
        echo "Flake8 report file:"
        if [ -f "$REPORT_DIR/flake8.json" ]; then
          echo "Flake8 report exists"
          echo "Flake8 report size: $(wc -c < $REPORT_DIR/flake8.json)"
          echo "Flake8 report preview:"
          head -20 $REPORT_DIR/flake8.json
        else
          echo "Flake8 report NOT found"
        fi
        echo "Running flake8 manually to check:"
        flake8 . --version
        echo "Running flake8 on current directory:"
        flake8 . --format=json || echo "No flake8 issues found"
        
    - name: Generate severity summary
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        print("DEBUG: Report directory: " + str(report_dir))
        print("DEBUG: Report directory exists: " + str(report_dir.exists()))
        print("DEBUG: Report directory contents: " + str(list(report_dir.glob('*'))))
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []
        
        # Process Bandit results
        if (report_dir / 'bandit.json').exists():
            try:
                with open(report_dir / 'bandit.json') as f:
                    bandit_data = json.load(f)
                    print("DEBUG: Bandit data loaded: " + str(len(bandit_data.get('results', []))) + " issues found")
                    
                    for result in bandit_data.get('results', []):
                        bandit_severity = result.get('issue_severity', 'unknown').upper()
                        
                        # Map bandit severity to our severity levels
                        if bandit_severity == 'HIGH':
                            severity_summary['high'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'MEDIUM':
                            severity_summary['medium'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'LOW':
                            severity_summary['low'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        else:
                            severity_summary['info'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                    
                    print("DEBUG: Bandit severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing bandit.json: " + str(e))
                print("DEBUG: Bandit file content preview:")
                try:
                    with open(report_dir / 'bandit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read bandit.json file")
        
        # Process Pylint results
        if (report_dir / 'pylint.json').exists():
            try:
                with open(report_dir / 'pylint.json') as f:
                    pylint_data = json.load(f)
                    for msg in pylint_data:
                        if msg.get('type') == 'error':
                            severity_summary['high'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
                        elif msg.get('type') == 'warning':
                            severity_summary['medium'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
            except Exception as e:
                print("Error processing pylint.json: " + str(e))
        
        # Process pip-audit results
        if (report_dir / 'pip_audit.json').exists():
            try:
                with open(report_dir / 'pip_audit.json') as f:
                    pip_audit_data = json.load(f)
                    for vuln in pip_audit_data.get('vulnerabilities', []):
                        severity = vuln.get('severity', 'unknown').lower()
                        if severity in severity_summary:
                            severity_summary[severity].append(dict(
                                tool='pip-audit',
                                file='requirements.txt',
                                issue=vuln.get('name', 'vulnerability'),
                                message=vuln.get('description', 'Security vulnerability')
                            ))
            except Exception as e:
                print("Error processing pip_audit.json: " + str(e))
        
        # Process Flake8 results
        if (report_dir / 'flake8.json').exists():
            try:
                with open(report_dir / 'flake8.json') as f:
                    flake8_data = json.load(f)
                    print("DEBUG: Flake8 data loaded: " + str(len(flake8_data)) + " issues found")
                    for result in flake8_data:
                        # Flake8 doesn't have severity, categorize by error code
                        error_code = result.get('code', '')
                        if error_code.startswith('E'):
                            severity_summary['high'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 error')
                            ))
                        elif error_code.startswith('W'):
                            severity_summary['medium'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 warning')
                            ))
                        else:
                            severity_summary['low'].append(dict(
                                tool='flake8',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=error_code,
                                message=result.get('text', 'Flake8 info')
                            ))
            except Exception as e:
                print("Error processing flake8.json: " + str(e))
                print("DEBUG: Flake8 file content preview:")
                try:
                    with open(report_dir / 'flake8.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read flake8.json file")
        else:
            print("DEBUG: flake8.json file not found")
        
        # Process Radon Cyclomatic Complexity results
        if (report_dir / 'radon_cc.json').exists():
            try:
                with open(report_dir / 'radon_cc.json') as f:
                    radon_data = json.load(f)
                    for file_path, metrics in radon_data.items():
                        complexity = metrics.get('total_complexity', 0)
                        if complexity > 10:
                            severity_summary['high'].append(dict(
                                tool='radon_cc',
                                file=file_path,
                                issue='high_complexity',
                                message='Cyclomatic complexity: ' + str(complexity)
                            ))
                        elif complexity > 5:
                            severity_summary['medium'].append(dict(
                                tool='radon_cc',
                                file=file_path,
                                issue='medium_complexity',
                                message='Cyclomatic complexity: ' + str(complexity)
                            ))
            except Exception as e:
                print("Error processing radon_cc.json: " + str(e))
        
        # Process Radon Maintainability Index results
        if (report_dir / 'radon_mi.json').exists():
            try:
                with open(report_dir / 'radon_mi.json') as f:
                    radon_data = json.load(f)
                    for file_path, metrics in radon_data.items():
                        mi_score = metrics.get('mi', 0)
                        if mi_score < 20:
                            severity_summary['high'].append(dict(
                                tool='radon_mi',
                                file=file_path,
                                issue='low_maintainability',
                                message='Maintainability Index: ' + str(mi_score)
                            ))
                        elif mi_score < 50:
                            severity_summary['medium'].append(dict(
                                tool='radon_mi',
                                file=file_path,
                                issue='medium_maintainability',
                                message='Maintainability Index: ' + str(mi_score)
                            ))
            except Exception as e:
                print("Error processing radon_mi.json: " + str(e))
        
        # Process Pydocstyle results
        if (report_dir / 'pydocstyle.json').exists():
            try:
                with open(report_dir / 'pydocstyle.json') as f:
                    pydocstyle_data = json.load(f)
                    for result in pydocstyle_data:
                        code = result.get('code', '')
                        if code.startswith('D'):
                            severity_summary['low'].append(dict(
                                tool='pydocstyle',
                                file=result.get('filename'),
                                line=result.get('line'),
                                issue=code,
                                message=result.get('message', 'Documentation style')
                            ))
            except Exception as e:
                print("Error processing pydocstyle.json: " + str(e))
        
        # Save severity summary
        with open(report_dir / 'severity_summary.json', 'w') as f:
            json.dump(severity_summary, f, indent=2)
            
        print("Severity summary generated successfully")
        EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30

name: Dynamic Python Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing Python packages..."
        pip install pylint pydocstyle scancode-toolkit trufflehog3 bandit pip-audit radon flake8==6.1.0 flake8-json==24.4.0 osv-scanner || go install github.com/google/osv-scanner/cmd/osv-scanner@latest
        echo "Installing additional scan tools..."
        pip install bandit pylint flake8==6.1.0 flake8-json==24.4.0 radon pydocstyle pip-audit
        echo "Installing Go for dependency scanning tools..."
        if command -v go >/dev/null 2>&1; then
          echo "Go is already installed"
        else
          echo "Installing Go..."
          wget -q https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
        fi
        export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        echo "Installing dependency scanning tools..."
        pip install osv-scanner || (go install github.com/google/osv-scanner/cmd/osv-scanner@latest && export PATH=$PATH:$HOME/go/bin) || echo "OSV Scanner installation failed"
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin || echo "Syft installation failed"
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || echo "Grype installation failed"
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || echo "Trivy installation failed"
        pip install scancode-toolkit || echo "ScanCode installation failed"
        pip install trufflehog3 || echo "TruffleHog installation failed"
        GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz && sudo tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks && sudo chmod +x /usr/local/bin/gitleaks || echo "Gitleaks installation failed"
        export PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin
        echo "PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Run scans
      run: |
        SRC_FILES=$(find . -name "*.py" ! -path "./.github/*")
        bandit -r . -f json -o $REPORT_DIR/bandit.json || true
        pylint $SRC_FILES --output-format=json > $REPORT_DIR/pylint.json || true
        flake8 . --format=json --output-file=$REPORT_DIR/flake8.json --exit-zero || true
        pip-audit -f json -o $REPORT_DIR/pip_audit.json || true
        radon cc $SRC_FILES -a -j > $REPORT_DIR/radon_cc.json || true
        radon mi $SRC_FILES -j > $REPORT_DIR/radon_mi.json || true
        pydocstyle $SRC_FILES --format=json > $REPORT_DIR/pydocstyle.json || true
        
        if command -v osv-scanner >/dev/null 2>&1; then
          osv-scanner scan --recursive . --format json --output $REPORT_DIR/osv_scanner.json 2>&1 || echo '{"results": []}' > $REPORT_DIR/osv_scanner.json
        else
          echo '{"results": []}' > $REPORT_DIR/osv_scanner.json
        fi
        
        syft . -o json=$REPORT_DIR/syft.json || echo '{"artifacts": []}' > $REPORT_DIR/syft.json
        trivy fs --format json --output $REPORT_DIR/trivy.json . || echo '{"Results": []}' > $REPORT_DIR/trivy.json
        grype dir:. -o json > $REPORT_DIR/grype.json || echo '{"matches": []}' > $REPORT_DIR/grype.json
        
        if command -v scancode >/dev/null 2>&1; then
          scancode --copyright --license --package --info --json-pp $REPORT_DIR/scancode.json . 2>&1 || echo '{"files": []}' > $REPORT_DIR/scancode.json
        else
          echo '{"files": []}' > $REPORT_DIR/scancode.json
        fi
        
        trufflehog filesystem --directory . --json > $REPORT_DIR/trufflehog.json 2>&1 || echo '{"results": []}' > $REPORT_DIR/trufflehog.json
        
        if command -v gitleaks >/dev/null 2>&1; then
          gitleaks detect --source . --report-format json --report-path $REPORT_DIR/gitleaks.json --no-git --verbose || echo '[]' > $REPORT_DIR/gitleaks.json
          if [ ! -f "$REPORT_DIR/gitleaks.json" ]; then echo '[]' > $REPORT_DIR/gitleaks.json; fi
        else
          echo '[]' > $REPORT_DIR/gitleaks.json
        fi
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30

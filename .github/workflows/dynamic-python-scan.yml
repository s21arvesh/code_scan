
name: Dynamic Python Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'bandit,pylint,flake8'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'python-project'

env:
  REPORT_DIR: scan-reports

jobs:
  python-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit radon pip-audit flake8==6.1.0 flake8-json==24.4.0 pylint pydocstyle
        echo "Installing additional scan tools..."
        pip install bandit pylint flake8==6.1.0 flake8-json==24.4.0 radon pydocstyle pip-audit
        echo "Verifying installations:"
        bandit --version
        pylint --version
        flake8 --version
        echo "Verifying flake8-json plugin:"
        flake8 --help | grep -i formatter || echo "flake8-json formatter not registered"
        radon --version
        pydocstyle --version
        pip-audit --version
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
    
    - name: Run Python code scans
      run: |
        echo "Starting Python code scans..."
        echo "Current directory: $(pwd)"
        echo "Report directory: $REPORT_DIR"
        echo "Python files found:"
        find . -name "*.py" -type f | head -10
        echo "=== Running Scan Commands ==="
        echo "DEBUG: Current directory: $(pwd)"
        echo "DEBUG: Python files in current directory:"
        find . -name "*.py" -type f -exec echo "  - file" \;
        echo "DEBUG: About to execute scan_commands..."
        # Add test files to force tool output
        echo "import os, sys, subprocess" > bad.py
        echo "" >> bad.py
        echo "def bad(x,y): return x+y" >> bad.py
        echo "" >> bad.py
        echo "eval('print("bandit")')" >> bad.py
        echo "" >> bad.py
        echo "exec('print("exec call")')" >> bad.py
        echo "" >> bad.py
        echo "subprocess.call(['ls'], shell=True)" >> bad.py

        # Add vulnerable dependency for pip-audit testing
        echo "requests==2.19.0" > requirements.txt

        SRC_FILES=$(find . -name "*.py" ! -path "./.github/*")
        echo "DEBUG: Found Python files: $SRC_FILES"

        bandit -r . -f json -o $REPORT_DIR/bandit.json || true

        pylint $SRC_FILES           --output-format=json           > $REPORT_DIR/pylint.json || true

        # Force flake8 violations
        echo "import os,sys" > flake8_test.py
        echo "x=1; y=2" >> flake8_test.py

        flake8 .           --format=json           --output-file=$REPORT_DIR/flake8.json           --exit-zero || true

        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

        pip-audit -f json -o $REPORT_DIR/pip_audit.json || true

        radon cc $SRC_FILES -a -j > $REPORT_DIR/radon_cc.json || true

        radon mi $SRC_FILES -j > $REPORT_DIR/radon_mi.json || true

        pydocstyle $SRC_FILES --format=json > $REPORT_DIR/pydocstyle.json || true
        echo "DEBUG: scan_commands completed"
        echo "=== Scan Commands Completed ==="
        echo "Report directory contents after scans:"
        ls -la $REPORT_DIR/
        echo "=== Checking each tool's report file ==="
        echo "Bandit report file:"
        if [ -f "$REPORT_DIR/bandit.json" ]; then
          echo "Bandit report exists"
          echo "Bandit report size: $(wc -c < $REPORT_DIR/bandit.json)"
          echo "Bandit report preview:"
          head -20 $REPORT_DIR/bandit.json
        else
          echo "Bandit report NOT found"
        fi
        echo "Pylint report file:"
        if [ -f "$REPORT_DIR/pylint.json" ]; then
          echo "Pylint report exists"
          echo "Pylint report size: $(wc -c < $REPORT_DIR/pylint.json)"
          echo "Pylint report preview:"
          head -20 $REPORT_DIR/pylint.json
        else
          echo "Pylint report NOT found"
        fi
        echo "Flake8 report file:"
        if [ -f "$REPORT_DIR/flake8.json" ]; then
          echo "Flake8 report exists"
          echo "Flake8 report size: $(wc -c < $REPORT_DIR/flake8.json)"
          echo "Flake8 report preview:"
          head -20 $REPORT_DIR/flake8.json
        else
          echo "Flake8 report NOT found"
        fi
        echo "Pip-audit report file:"
        if [ -f "$REPORT_DIR/pip_audit.json" ]; then
          echo "Pip-audit report exists"
          echo "Pip-audit report size: $(wc -c < $REPORT_DIR/pip_audit.json)"
          echo "Pip-audit report preview:"
          head -20 $REPORT_DIR/pip_audit.json
        else
          echo "Pip-audit report NOT found"
        fi
        echo "Radon CC report file:"
        if [ -f "$REPORT_DIR/radon_cc.json" ]; then
          echo "Radon CC report exists"
          echo "Radon CC report size: $(wc -c < $REPORT_DIR/radon_cc.json)"
          echo "Radon CC report preview:"
          head -20 $REPORT_DIR/radon_cc.json
        else
          echo "Radon CC report NOT found"
        fi
        echo "Radon MI report file:"
        if [ -f "$REPORT_DIR/radon_mi.json" ]; then
          echo "Radon MI report exists"
          echo "Radon MI report size: $(wc -c < $REPORT_DIR/radon_mi.json)"
          echo "Radon MI report preview:"
          head -20 $REPORT_DIR/radon_mi.json
        else
          echo "Radon MI report NOT found"
        fi
        echo "Pydocstyle report file:"
        if [ -f "$REPORT_DIR/pydocstyle.json" ]; then
          echo "Pydocstyle report exists"
          echo "Pydocstyle report size: $(wc -c < $REPORT_DIR/pydocstyle.json)"
          echo "Pydocstyle report preview:"
          head -20 $REPORT_DIR/pydocstyle.json
        else
          echo "Pydocstyle report NOT found"
        fi
        echo "=== Manual tool checks ==="
        echo "Running bandit manually to debug:"
        echo "Bandit version:"
        bandit --version
        echo "Manual bandit execution:"
        bandit -r . -f json || echo "Bandit failed"
        echo "Manual bandit to file:"
        bandit -r . -f json > $REPORT_DIR/manual_bandit.json 2>/dev/null || echo "Manual bandit to file failed"
        echo "Manual bandit file size: $(wc -c < $REPORT_DIR/manual_bandit.json 2>/dev/null || echo '0')"
        echo "Manual bandit file preview:"
        head -10 $REPORT_DIR/manual_bandit.json 2>/dev/null || echo "No manual bandit file"
        echo "Running flake8 manually to check:"
        flake8 . --version
        echo "Running flake8 on current directory:"
        flake8 . --format=json || echo "No flake8 issues found"
        
    - name: Generate severity summary
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        print("DEBUG: Report directory: " + str(report_dir))
        print("DEBUG: Report directory exists: " + str(report_dir.exists()))
        print("DEBUG: Report directory contents: " + str(list(report_dir.glob('*'))))
        
        # Mandatory debug: Show raw tool outputs
        print("=== DEBUG: Raw tool outputs ===")
        for tool_file in ['radon_cc.json', 'radon_mi.json', 'pip_audit.json']:
            file_path = report_dir / tool_file
            if file_path.exists():
                print(tool_file + " content:")
                print(file_path.read_text())
            else:
                print(tool_file + " not found")
        print("=== END DEBUG ===")

        # Check which report files exist
        report_files = ['bandit.json', 'pylint.json', 'flake8.json', 'pip_audit.json', 'radon_cc.json', 'radon_mi.json', 'pydocstyle.json']
        for file_name in report_files:
            file_path = report_dir / file_name
            if file_path.exists():
                print("DEBUG: " + file_name + " exists with size: " + str(file_path.stat().st_size))
            else:
                print("DEBUG: " + file_name + " does not exist")
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []
        
        # Process Bandit results
        if (report_dir / 'bandit.json').exists():
            try:
                with open(report_dir / 'bandit.json') as f:
                    bandit_data = json.load(f)
                    print("DEBUG: Bandit data loaded: " + str(len(bandit_data.get('results', []))) + " issues found")
                    
                    for result in bandit_data.get('results', []):
                        bandit_severity = result.get('issue_severity', 'unknown').upper()
                        
                        # Map bandit severity to our severity levels
                        if bandit_severity == 'HIGH':
                            severity_summary['high'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'MEDIUM':
                            severity_summary['medium'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        elif bandit_severity == 'LOW':
                            severity_summary['low'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                        else:
                            severity_summary['info'].append(dict(
                                tool='bandit',
                                file=result.get('filename'),
                                line=result.get('line_number'),
                                issue=result.get('test_name'),
                                message=result.get('issue_text')
                            ))
                    
                    print("DEBUG: Bandit severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing bandit.json: " + str(e))
                print("DEBUG: Bandit file content preview:")
                try:
                    with open(report_dir / 'bandit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read bandit.json file")
        
        # Process Pylint results
        if (report_dir / 'pylint.json').exists():
            try:
                with open(report_dir / 'pylint.json') as f:
                    pylint_data = json.load(f)
                    for msg in pylint_data:
                        if msg.get('type') == 'error':
                            severity_summary['high'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
                        elif msg.get('type') == 'warning':
                            severity_summary['medium'].append(dict(
                                tool='pylint',
                                file=msg.get('path'),
                                line=msg.get('line'),
                                issue=msg.get('message-id'),
                                message=msg.get('message')
                            ))
            except Exception as e:
                print("Error processing pylint.json: " + str(e))
        
        # Process pip-audit results
        if (report_dir / 'pip_audit.json').exists():
            try:
                with open(report_dir / 'pip_audit.json') as f:
                    pip_audit_data = json.load(f)
                    print("DEBUG: Pip-audit data loaded: " + str(len(pip_audit_data.get('dependencies', []))) + " dependencies found")
                    print("DEBUG: Pip-audit raw data structure: " + str(list(pip_audit_data.keys()) if isinstance(pip_audit_data, dict) else type(pip_audit_data)))
                    
                    # Debug: Show first dependency structure
                    deps = pip_audit_data.get('dependencies', [])
                    if deps:
                        print("DEBUG: First dependency structure: " + str(deps[0]))
                        print("DEBUG: First dependency keys: " + str(list(deps[0].keys()) if isinstance(deps[0], dict) else type(deps[0])))
                    
                    vuln_count = 0
                    for dep in pip_audit_data.get("dependencies", []):
                        for vuln in dep.get("vulns", []):
                            # pip-audit does NOT give severity â†’ treat all as HIGH
                            severity_summary["high"].append({
                                "tool": "pip-audit",
                                "file": dep.get("name"),
                                "issue": vuln.get("id"),
                                "message": vuln.get("description")
                            })
                    print("DEBUG: Pip-audit severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing pip_audit.json: " + str(e))
                print("DEBUG: Pip-audit file content preview:")
                try:
                    with open(report_dir / 'pip_audit.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read pip_audit.json file")
        else:
            print("DEBUG: pip_audit.json file not found")
        
        # Process Flake8 results (SAFE)
        flake8_file = report_dir / "flake8.json"

        if flake8_file.exists() and flake8_file.stat().st_size > 2:
            with open(flake8_file) as f:
                flake8_data = json.load(f)

                if isinstance(flake8_data, dict):
                    for filename, issues in flake8_data.items():
                        for issue in issues:
                            code = issue.get("code", "")
                            if code.startswith("E"):
                                severity = "high"
                            elif code.startswith("W"):
                                severity = "medium"
                            else:
                                severity = "low"

                            severity_summary[severity].append({
                                "tool": "flake8",
                                "file": filename,
                                "line": issue.get("line_number"),
                                "issue": code,
                                "message": issue.get("text")
                            })
                else:
                    print("DEBUG: flake8.json not dict, skipping")
        else:
            print("DEBUG: flake8.json missing or empty")
        
        # Process Radon Cyclomatic Complexity results
        if (report_dir / 'radon_cc.json').exists():
            try:
                with open(report_dir / 'radon_cc.json') as f:
                    radon_data = json.load(f)
                    print("DEBUG: Radon CC data loaded: " + str(len(radon_data)) + " files analyzed")
                    print("DEBUG: Radon CC raw data structure: " + str(list(radon_data.keys()) if isinstance(radon_data, dict) else type(radon_data)))
                    for file_path, blocks in radon_data.items():
                        if not isinstance(blocks, list):
                            continue
                        for block in blocks:
                            complexity = block.get("complexity", 0)
                            if complexity >= 2:
                                severity_summary["medium"].append(dict(
                                    tool="radon_cc",
                                    file=file_path,
                                    line=block.get("lineno", 0),
                                    issue="high_cyclomatic_complexity",
                                    message=block.get('name') + " complexity = " + str(complexity)
                                ))
                    print("DEBUG: Radon CC severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing radon_cc.json: " + str(e))
                print("DEBUG: Radon CC file content preview:")
                try:
                    with open(report_dir / 'radon_cc.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read radon_cc.json file")
        else:
            print("DEBUG: radon_cc.json file not found")
        
        # Process Radon Maintainability Index results
        if (report_dir / 'radon_mi.json').exists():
            try:
                with open(report_dir / 'radon_mi.json') as f:
                    radon_data = json.load(f)
                    print("DEBUG: Radon MI data loaded: " + str(len(radon_data)) + " files analyzed")
                    print("DEBUG: Radon MI raw data structure: " + str(list(radon_data.keys()) if isinstance(radon_data, dict) else type(radon_data)))
                    for file, data in radon_data.items():
                        mi = data.get("mi", 100)
                        if mi < 95:
                            severity = "medium"
                        elif mi < 90:
                            severity = "low"
                        else:
                            continue

                        severity_summary[severity].append({
                            "tool": "radon_mi",
                            "file": file,
                            "issue": "maintainability",
                            "message": "MI score = " + str(mi)
                        })
                    print("DEBUG: Radon MI severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing radon_mi.json: " + str(e))
                print("DEBUG: Radon MI file content preview:")
                try:
                    with open(report_dir / 'radon_mi.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read radon_mi.json file")
        else:
            print("DEBUG: radon_mi.json file not found")
        
        # Process Pydocstyle results
        if (report_dir / 'pydocstyle.json').exists():
            try:
                with open(report_dir / 'pydocstyle.json') as f:
                    pydocstyle_data = json.load(f)
                    print("DEBUG: Pydocstyle data loaded: " + str(len(pydocstyle_data)) + " issues found")
                    print("DEBUG: Pydocstyle issues: " + str(len(pydocstyle_data)))
                    for issue in pydocstyle_data:
                        severity_summary["low"].append({
                            "tool": "pydocstyle",
                            "file": issue.get("filename"),
                            "line": issue.get("line"),
                            "issue": issue.get("code"),
                            "message": issue.get("message")
                        })
                    print("DEBUG: Pydocstyle severity summary: " + str(severity_summary))
            except Exception as e:
                print("Error processing pydocstyle.json: " + str(e))
                print("DEBUG: Pydocstyle file content preview:")
                try:
                    with open(report_dir / 'pydocstyle.json', 'r') as f:
                        content = f.read()[:500]  # First 500 chars
                        print("DEBUG: " + content)
                except:
                    print("DEBUG: Could not read pydocstyle.json file")
        else:
            print("DEBUG: pydocstyle.json file not found")
        
        # Save severity summary
        with open(report_dir / 'severity_summary.json', 'w') as f:
            json.dump(severity_summary, f, indent=2)
        
        # Check manual bandit results if automated failed
        if (report_dir / 'manual_bandit.json').exists():
            try:
                with open(report_dir / 'manual_bandit.json') as f:
                    manual_bandit_data = json.load(f)
                    print("DEBUG: Manual bandit results:")
                    print("Issues found: " + str(len(manual_bandit_data.get('results', []))))
                    for result in manual_bandit_data.get('results', [])[:5]:  # Show first 5
                        print("  - " + result.get('test_name', 'Unknown') + ": " + result.get('issue_text', 'No description'))
            except Exception as e:
                print("DEBUG: Error reading manual bandit: " + str(e))
        
        print("=== FINAL SEVERITY SUMMARY ===")
        for severity, issues in severity_summary.items():
            print(str(severity) + ": " + str(len(issues)) + " issues")
        print("Severity summary generated successfully")
        EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
